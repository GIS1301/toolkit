<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        html,
        body {
            width: 100%;
            height: 100%;
        }

        html {
            font-size: 20px;
        }

        body {
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            font-size: 0.8rem;
            background-color: #51074b;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .btngroups {
            position: fixed;
            top: 20px;
            left: 100px;
        }

        .btn {
            display: block;
            float: left;
            line-height: 40px;
            margin: 5px 10px;
            padding: 0 20px;
            color: #fff;
            background-color: rgba(255, 255, 255, .2);
            border: none;
            outline: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="btngroups">
        <label for="file" class="btn">选择文件</label>
        <input id="file" type="file" accept="audio/*" style="display:none;" />
        <button id="playBtn" class="btn">loading...</button>
        <input id="slideBtn" type="range" min="0" max="1" step="0.01" value="1" />
    </div>
    <audio id="audio" crossorigin="anonymous" controls></audio>
    <canvas id="canvas"></canvas>
</body>
<script>

    // class
    (function AudioVisual(global) {
        // constructor
        function AudioVisual(file, audio, canvas, config) {
            this.audioFile = file;
            this.audioElement = audio;
            this.canvasElement = canvas;
            this.config =Object.assign({
                isAutoRun: true,
                isVibrating: false,
                thickness: 1024, // Must be a power of 2 between 2^5 and 2^15, 32~32768. Defaults to 2048.
            },config || {});
            this.__init();
        }
        AudioVisual.prototype = {
            constructor: AudioVisual,
            __init: function () {
                // setting
                this.state = "loading";
                this.__animateState = "stop";
                this.vibrateArr = [0, 0];

                // audio
                this.audioContext = new window.AudioContext();
                this.sourceNode = this.audioContext.createMediaElementSource(this.audioElement);
                this.analyser = this.audioContext.createAnalyser();

                this.analyser.fftSize = this.config.thickness;
                this.freqByteData = new Uint8Array(this.analyser.frequencyBinCount);
                this.sourceNode.connect(this.analyser);
                this.analyser.connect(this.audioContext.destination);
                // add listener to audio
                this.__onRunning();

                // canvas
                this.canvasContext = this.canvasElement.getContext("2d");
                this.canvasElement.width = window.outerWidth;
                this.canvasElement.height = window.outerHeight;
                if (window.outerWidth < window.outerHeight) {
                    this.canvasElement.width = window.outerHeight;
                    this.canvasElement.height = window.outerWidth;
                    this.canvasElement.style.cssText = `
                        -webkit-transform:rotate(-90deg);
                        transform:rotate(-90deg);
                    `;
                }
                this.canvasContext.strokeStyle = "#fff";
                this.canvasContext.rotate(Math.PI);
                this.canvasContext.translate(0, -this.canvasElement.height);
                this.canvasContext.scale(-1, 1);
                this.canvasContext.beginPath();
                this.canvasContext.moveTo(0, 128);
                this.canvasContext.lineTo(this.canvasElement.width, 128);
                this.canvasContext.stroke();
                this.canvasContext.closePath();
                // setting
                this.gradient = null;
                this.lw = 10;

                // vibarte
                navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;

                // add listener to file
                this.__onFileChange();
            },
            __onRunning: function () {
                this.audioElement.addEventListener("play", ev => {
                    this.state = "playing";
                    this.config.isAutoRun && this.__animateState != "start" && this.startDance();
                });
                this.audioElement.addEventListener("pause", ev => {
                    this.state = "paused";
                    this.config.isAutoRun && this.stopDance();
                });
            },
            __onFileChange: function () {
                this.audioFile.addEventListener("change", ev => {
                    var file = ev.target.files[0];
                    // decode
                    var reader = new FileReader();
                    this.state = "paused";
                    reader.addEventListener("load", ev => {
                        var source = ev.target.result;
                        this.state = "playing";
                        this.__clearCanvas();
                        this.audioElement.src = source;
                        this.config.isAutoRun && (_ => {
                            this.audioElement.play();
                            this.startDance();
                        })();
                    });
                    reader.readAsDataURL(file);
                });
            },
            __clearCanvas: function () {
                this.canvasContext.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
            },
            __drawSLine: function (arr) {
                this.__clearCanvas();
                this.canvasContext.save();
                this.canvasContext.beginPath();
                this.canvasContext.moveTo(0, 0);
                arr.forEach((item, n) => {
                    this.gradient = this.canvasContext.createLinearGradient(n * (this.lw + 1), 0, n * (this.lw + 1), item);
                    this.gradient.addColorStop(0, "#ffff00");
                    this.gradient.addColorStop(0.2, "#ffd400");
                    this.gradient.addColorStop(0.4, "#ffaa00");
                    this.gradient.addColorStop(0.6, "#ff7f00");
                    this.gradient.addColorStop(0.8, "#ff5500");
                    this.gradient.addColorStop(1, "#ff2a00");
                    this.canvasContext.fillStyle = this.gradient;
                    this.canvasContext.fillRect(n * (this.lw + 1), 0, this.lw, item);
                });
                this.canvasContext.closePath();
                this.canvasContext.beginPath();
                this.canvasContext.moveTo(0, 128);
                this.canvasContext.lineTo(this.canvasElement.width, 128);
                this.canvasContext.stroke();
                this.canvasContext.closePath();
                this.canvasContext.restore();
            },
            __animate: function () {
                this.analyser.getByteFrequencyData(this.freqByteData);
                this.__drawSLine(this.freqByteData);
                this.config.isVibrating && (_ => {
                    this.vibrateArr = this.freqByteData.filter(function (item, n) {
                        return item > 10 && item < 200;
                    });
                    this.vibrateArr = [
                        Math.max.apply(null, this.vibrateArr),
                        Math.min.apply(null, this.vibrateArr)
                    ];
                    navigator.vibrate(this.vibrateArr[0]);
                })();
            },
            stopDance: function (cb) {
                this.__animateState = "stop";
                clearTimeout(this.__TIMEOUT_ID);
                this.__TIMEOUT_ID = setTimeout(_ => {
                    clearInterval(this.__INTERVAL_ID);
                    this.__clearCanvas();
                    cb && cb();
                }, 1500);
                this.config.isVibrating && navigator.vibrate(0);
            },
            startDance: function () {
                clearTimeout(this.__TIMEOUT_ID);
                clearInterval(this.__INTERVAL_ID);
                this.__animateState = "start";
                this.__INTERVAL_ID = setInterval(this.__animate.bind(this), this.vibrateArr[1]);
            },
        };
        // export
        global.AudioVisual = AudioVisual;
    }(this));

    var av = new AudioVisual(file, audio, canvas,{isVibrating:true});

    playBtn.addEventListener("click", function () {
        if (av.state == "loading") {
            console.log("加载中...");
            this.innerHTML = "loading";
        } else if (av.state == "paused") {
            audio.play();
            this.innerHTML = "pause";
        } else {
            audio.pause();
            this.innerHTML = "play";
        };
    });

    slideBtn.addEventListener("input", function () {
        audio.volume = Number(this.value).toFixed(2);
    });

</script>

</html>